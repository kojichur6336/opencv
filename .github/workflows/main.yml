name: iOS ç¼–è¯‘æ„å»º (è‡ªå®šä¹‰å·¥å…·é“¾ç‰ˆ)

on:
  push:
    tags:
      - '*' 
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚ 1.0.0)'
        required: false
        default: '1.0.0'
      body:
        description: 'æ›´æ–°æ—¥å¿— (å¦‚éœ€æ¢è¡Œè¯·è¾“å…¥ \nï¼Œä¾‹å¦‚: 1.ä¼˜åŒ–å†…å®¹ \n 2.ä¿®å¤Bug)'
        required: false
        default: 'å¸¸è§„æ€§èƒ½ä¼˜åŒ–ä¸ bug ä¿®å¤'

permissions:
  contents: write

jobs:
  build:
    name: æ­£åœ¨æ‰§è¡Œç¼–è¯‘ä»»åŠ¡
    runs-on: macos-15 

    steps:
      - name: 1. æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0 

      - name: 2. å¼ºåˆ¶æŒ‡å®š Xcode ç‰ˆæœ¬ (16.4)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4' 

      - name: 3. è¾“å‡ºè¯¦ç»†ç¯å¢ƒä¿¡æ¯
        run: |
          echo "========= ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯ ========="
          sw_vers
          echo -e "\n========= ğŸ› ï¸ Xcode è·¯å¾„ ========="
          xcode-select -p
          xcodebuild -version

      - name: 4. é…ç½®è‡ªå®šä¹‰ Ollvm å·¥å…·é“¾ (Hikari)
        run: |
          echo "ğŸš€ ä¸‹è½½å¹¶è§£å‹å·¥å…·é“¾..."
          curl -L "https://github.com/LiuSky/XCode-LLVM-Toolchains/releases/download/v1.0.0-M-Series/Hikari-LLVM15-Toolchain.tar.gz" -o Hikari.tar.gz
          tar -xzf Hikari.tar.gz
          TC_NAME=$(ls -d *.xctoolchain | head -n 1)
          XCODE_TC_PATH="$(xcode-select -p)/Toolchains/"
          sudo cp -R "$TC_NAME" "$XCODE_TC_PATH"

          echo "ğŸ”§ è¡¥å…¨ç³»ç»Ÿåº“ (compiler-rt)..."
          DEFAULT_CLANG_LIB_DIR=$(ls -d "$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang"/*/lib | head -n 1)
          CUSTOM_CLANG_VERSION_DIR=$(ls -d "$XCODE_TC_PATH/$TC_NAME/usr/lib/clang"/* | head -n 1)
          sudo cp -R "$DEFAULT_CLANG_LIB_DIR" "$CUSTOM_CLANG_VERSION_DIR/"
          echo "âœ… å·¥å…·é“¾å®‰è£…å®Œæˆã€‚"

      - name: 5. å®‰è£…ä¾èµ– (dpkg, ldid)
        run: brew install dpkg ldid

      - name: 6. æƒé™è®¾ç½®
        working-directory: ./Build 
        run: find . -name "*.sh" -exec chmod +x {} +

      - name: 7. æå–ä¸å¤„ç†æ›´æ–°æ—¥å¿—
        id: get_log
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            LOG_CONTENT="${{ github.event.inputs.body }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # è¿™é‡Œçš„ --format='%(contents)' æ˜¯ä¿ç•™æ¢è¡Œçš„å…³é”®
            TAG_MSG=$(git tag -l --format='%(contents)' ${{ github.ref_name }} | sed 's/[[:space:]]*$//')
            [[ -z "$TAG_MSG" ]] && TAG_MSG=$(git log -1 --pretty=format:"%s%n%n%b")
            LOG_CONTENT="$TAG_MSG"
          else
            LOG_CONTENT=$(git log -1 --pretty=format:"%s%n%n%b")
          fi

          # ç»Ÿä¸€å¤„ç†å­—é¢é‡ \n å­—ç¬¦
          FINAL_LOG=$(echo "$LOG_CONTENT" | perl -pe 's/\\r\\n/\n/g; s/\\n/\n/g')

          echo "COMMIT_LOG<<EOF" >> $GITHUB_ENV
          echo "$FINAL_LOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 8. æ‰§è¡Œå¤šæ¶æ„ç¼–è¯‘
        working-directory: ./Build
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RAW_VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            RAW_VERSION="${{ github.ref_name }}"
          else
            RAW_VERSION="1.0.0"
          fi
          VERSION=${RAW_VERSION#v}
          
          BUILD_CONFIGS=("rootful:_iphoneos-arm" "rootless:_iphoneos-arm64" "roothide:_iphoneos-arm64e")
          for CONFIG in "${BUILD_CONFIGS[@]}"; do
            MODE=${CONFIG%%:*}
            SUFFIX=${CONFIG#*:}
            make $MODE mode=log0
            
            OLD_FILE="Packages/com.sky.ykpro.deb"
            NEW_FILE="Packages/com.sky.ykpro_${VERSION}${SUFFIX}.deb"
            [ -f "$OLD_FILE" ] && mv "$OLD_FILE" "$NEW_FILE"
          done
          echo "FINAL_TAG=$RAW_VERSION" >> $GITHUB_ENV
        env:
          PREFIX: /opt/homebrew/bin/

      - name: 9. ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: all-packages
          path: Build/Packages/*.deb

      - name: 10. å‘å¸ƒ Release
        if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.FINAL_TAG }}
          files: Build/Packages/*.deb
          body: |
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            ${{ env.COMMIT_LOG }}

            ---
            ### ğŸ“¦ æ„å»ºè¯¦æƒ…
            - **ç‰ˆæœ¬**: ${{ env.FINAL_TAG }}
            - **å·¥å…·**: Xcode 16.4 / Ollvm 15
            - **æ¶æ„**: Rootful, Rootless, Roothide
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
