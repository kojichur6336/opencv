name: iOS ç¼–è¯‘æ„å»º

on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    name: æ­£åœ¨æ‰§è¡Œç¼–è¯‘ä»»åŠ¡
    runs-on: macos-15 

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å¼ºåˆ¶æŒ‡å®š Xcode ç‰ˆæœ¬
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: è¾“å‡ºè¯¦ç»†ç¯å¢ƒä¿¡æ¯
        run: |
          echo "========= ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯ ========="
          sw_vers
          echo -e "\n========= ğŸ› ï¸ Xcode è·¯å¾„ ========="
          xcode-select -p
          xcodebuild -version

      - name: Get Release Version
        run: |
          cd YKApp/YKApp.xcodeproj
          # ä½¿ç”¨ perl åŒ¹é… Release é…ç½®å—ä¸­çš„ MARKETING_VERSION
          VERSION=$(perl -ne 'print $1 if /Release/ .. /MARKETING_VERSION = (.*?);/ and /MARKETING_VERSION = (.*?);/' project.pbxproj | head -n 1)

          if [ -z "$VERSION" ]; then
            echo "âŒ é”™è¯¯: æ— æ³•åœ¨ Release é…ç½®ä¸­æ‰¾åˆ° MARKETING_VERSION"
            exit 1
          fi

          echo "âœ… æˆåŠŸè·å– Release ç‰ˆæœ¬å·: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: é…ç½®è‡ªå®šä¹‰ Ollvm å·¥å…·é“¾ (Hikari)
        run: |
          echo "ğŸš€ ä¸‹è½½å¹¶è§£å‹å·¥å…·é“¾..."
          curl -L "https://github.com/LiuSky/XCode-LLVM-Toolchains/releases/download/v1.0.0-M-Series/Hikari-LLVM15-Toolchain.tar.gz" -o Hikari.tar.gz
          tar -xzf Hikari.tar.gz
          TC_NAME=$(ls -d *.xctoolchain | head -n 1)
          XCODE_TC_PATH="$(xcode-select -p)/Toolchains/"
          sudo cp -R "$TC_NAME" "$XCODE_TC_PATH"

          echo "ğŸ”§ è¡¥å…¨ç³»ç»Ÿåº“ (compiler-rt)..."
          DEFAULT_CLANG_LIB_DIR=$(ls -d "$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang"/*/lib | head -n 1)
          CUSTOM_CLANG_VERSION_DIR=$(ls -d "$XCODE_TC_PATH/$TC_NAME/usr/lib/clang"/* | head -n 1)
          sudo cp -R "$DEFAULT_CLANG_LIB_DIR" "$CUSTOM_CLANG_VERSION_DIR/"
          echo "âœ… å·¥å…·é“¾å®‰è£…å®Œæˆã€‚"

      - name: å®‰è£…ä¾èµ– (dpkg, ldid)
        run: brew install dpkg ldid

      - name: æƒé™è®¾ç½®
        working-directory: ./Build 
        run: find . -name "*.sh" -exec chmod +x {} +

      - name: æ‰§è¡Œå¤šæ¶æ„ç¼–è¯‘
        working-directory: ./Build
        run: |
          BUILD_CONFIGS=("rootful:_iphoneos-arm" "rootless:_iphoneos-arm64" "roothide:_iphoneos-arm64e")
          for CONFIG in "${BUILD_CONFIGS[@]}"; do
            MODE=${CONFIG%%:*}
            SUFFIX=${CONFIG#*:}
            make $MODE mode=log0
            
            OLD_FILE="Packages/com.sky.ykpro.deb"
            NEW_FILE="Packages/com.sky.ykpro_${VERSION}${SUFFIX}.deb"
            [ -f "$OLD_FILE" ] && mv "$OLD_FILE" "$NEW_FILE"
          done

      - name: å‘å¸ƒ Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          files: Build/Packages/*.deb
          body: |
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            ${{ github.event.head_commit.message }}

            ---
            ### ğŸ“¦ æ„å»ºè¯¦æƒ…
            - **ç‰ˆæœ¬**: ${{ env.VERSION }}
            - **å·¥å…·**: Xcode 16.4 / Ollvm 15
            - **æ¶æ„**: Rootful, Rootless, Roothide
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Packages
          path: Build/Packages/*.deb
          retention-days: 30
